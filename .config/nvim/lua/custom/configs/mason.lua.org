local status, mason = pcall(require, "mason")
if not status then
  return
end

local mason_lspconfig = require "mason-lspconfig"
local lsp_status = require "lsp-status"
local lspconfig = require "lspconfig"
local mason_nls = require 'mason-null-ls'
mason_nls.setup({
  ensure_installed = { 'prettierd', 'rubocop', 'black', 'goimports' },
  handlers = {},
})
vim.keymap.set('n', '<leader>p', function() vim.lsp.buf.format { async = true } end)
require("mason-tool-installer").setup {
  ensure_installed = ensure_installed,
  auto_update = false,
  run_on_start = true,
  start_delay = 3000,
}
require("mason-tool-installer").run_on_start()
local nls = require 'null-ls'

nls.setup({
  sources = {
    nls.builtins.formatting.prettierd,
    nls.builtins.diagnostics.rubocop,
    nls.builtins.formatting.rubocop,
    nls.builtins.formatting.black,
    nls.builtins.formatting.goimports,
  },
  debug = false,
})

local servers = {
  bashls = {},
  clangd = {
    cmd = {
      "clangd", -- '--background-index',
      "--clang-tidy",
      "--completion-style=bundled",
      "--header-insertion=iwyu",
      "--suggest-missing-includes",
      "--cross-file-rename",
    },
    handlers = lsp_status.extensions.clangd.setup(),
    init_options = {
      clangdFileStatus = true,
      usePlaceholders = true,
      completeUnimported = true,
      semanticHighlighting = true,
    },
  },
  cssls = {
    filetypes = { "css", "scss", "less", "sass" },
    root_dir = lspconfig.util.root_pattern("package.json", ".git"),
  },
  ghcide = {},
  html = {},
  jsonls = { cmd = { "json-languageserver", "--stdio" } },
  julials = {
    settings = { julia = { format = { indent = 2 } } },
  },
  ocamllsp = {},
  -- pyls_ms = {
  --   cmd = {'mspyls'},
  --   handlers = lsp_status.extensions.pyls_ms.setup(),
  --   settings = {
  --     python = {
  --       jediEnabled = false,
  --       analysis = {cachingLevel = 'Library'},
  --       formatting = {provider = 'yapf'},
  --       venvFolders = {"envs", ".pyenv", ".direnv", ".cache/pypoetry/virtualenvs"},
  --       workspaceSymbols = {enabled = true}
  --     }
  --   },
  --   root_dir = function(fname)
  --     return lspconfig.util.root_pattern('pyproject.toml', 'setup.py', 'setup.cfg',
  --     'requirements.txt', 'mypy.ini', '.pylintrc', '.flake8rc',
  --     '.gitignore')(fname) or
  --     lspconfig.util.find_git_ancestor(fname) or vim.loop.os_homedir()
  --   end
  -- },
  pyright = {
    handlers = {
      ["client/registerCapability"] = function(_, _, z, j)
        -- print(vim.inspect(y), vim.inspect(z), vim.inspect(j))
        return {
          result = nil,
          error = nil,
        }
      end,
    },
    settings = {
      python = {
        formatting = { provider = "yapf" },
      },
    },
  },
  rust_analyzer = {
    settings = {
      ["rust-analyzer"] = {
        cargo = {
          allFeatures = true,
        },
        checkOnSave = {
          allFeatures = true,
          command = "clippy",
        },
        procMacro = {
          ignored = {
            ["async-trait"] = { "async_trait" },
            ["napi-derive"] = { "napi" },
            ["async-recursion"] = { "async_recursion" },
          },
        },
      },
    },
  },
--   lua_ls = {
--     settings = {
--       Lua = {
--         runtime = {
--           version = 'Lua 5.4',
--           path = {
--             '?.lua',
--             '?/init.lua',
--             vim.fn.expand'~/.luarocks/share/lua/5.4/?.lua',
--             vim.fn.expand'~/.luarocks/share/lua/5.4/?/init.lua',
--             '/usr/local/share/5.4/?.lua',
--             '/usr/local/share/lua/5.4/?/init.lua'
--           }
--         },
--         workspace = {
--           library = {
--             vim.fn.expand'~/.luarocks/share/lua/5.4',
--             '/usr/local/share/lua/5.4'
--           }
--         }
--       }
--     },
--   },
--   sumneko_lua = {
--     cmd = { "lua-language-server" },
--     settings = {
--       Lua = {
--         diagnostics = { globals = { "vim" } },
--         -- completion = {keywordSnippet = 'Disable'},
--         runtime = { version = "LuaJIT", path = vim.split(package.path, ";") },
--         workspace = {
--           library = {
--             [vim.fn.expand "$VIMRUNTIME/lua"] = true,
--             [vim.fn.expand "$VIMRUNTIME/lua/vim/lsp"] = true,
--           },
--         },
--         completion = {
--           enable = true,
--           showWord = "Disable",
--           -- keywordSnippet = 'Disable',
--         },
--         -- Do not send telemetry data containing a randomized but unique identifier
--         telemetry = {
--           enable = false,
--         },
--       },
--     },
--   },
  texlab = {
    settings = {
      latex = { forwardSearch = { executable = "okular", args = { "--unique", "file:%p#src:%l%f" } } },
    },
    commands = {
      TexlabForwardSearch = {
        function()
          local pos = vim.api.nvim_win_get_cursor(0)
          local params = {
            textDocument = { uri = vim.uri_from_bufnr(0) },
            position = { line = pos[1] - 1, character = pos[2] },
          }

          vim.lsp.buf_request(0, "textDocument/forwardSearch", params, function(err, _, result, _)
            if err then
              error(tostring(err))
            end
            print("Forward search " .. vim.inspect(pos) .. " " .. texlab_search_status[result])
          end)
        end,
        description = "Run synctex forward search",
      },
    },
  },
  tsserver = {},
  vimls = {},
  hls = {},
  solargraph = {},
  terraformls = {},
  black = {},
  ruff = {},
}

-- Here we declare which settings to pass to the mason, and also ensure servers are installed. If not, they will be installed automatically.
local settings = {
  ui = {
    check_outdated_packages_on_open = false,
    border = "rounded",
    icons = {
      package_installed = "◍",
      package_pending = "◍",
      package_uninstalled = "◍",
    },
  },
  log_level = vim.log.levels.WARN,
  max_concurrent_installers = 4,
  registries = {
    "lua:mason-registry.index",
  },
  providers = {
    "mason.providers.registry-api",
    "mason.providers.client",
  },
}

mason.setup(settings)
mason_lspconfig.setup_handlers {
  function(server_name)
    local opts = {
      capabilities = require("cmp_nvim_lsp").default_capabilities(),
    }
    opts.on_attach = function(_, bufnr)
      local bufopts = { silent = true, buffer = bufnr }
      vim.keymap.set("n", "<C-k>", vim.lsp.buf.signature_help(), bufopts)
      vim.keymap.set("n", "<space>D", vim.lsp.buf.type_definition(), bufopts)
      vim.keymap.set("n", "<space>ca", vim.lsp.buf.code_action(), bufopts)
      vim.keymap.set("n", "<space>e", vim.lsp.diagnostic.show_line_diagnostics(), bufopts)
      vim.keymap.set("n", "<space>f", vim.lsp.buf.formatting(), bufopts)
      vim.keymap.set("n", "<space>p", vim.lsp.buf.format, bufopts)
      vim.keymap.set("n", "<space>q", vim.lsp.diagnostic.vim.keymap.set_loclist(), bufopts)
      vim.keymap.set("n", "<space>rn", vim.lsp.buf.rename(), bufopts)
      vim.keymap.set("n", "<space>wa", vim.lsp.buf.add_workspace_folder(), bufopts)
      vim.keymap.set("n", "<space>wl", print(vim.inspect(vim.lsp.buf.list_workspace_folders())), bufopts)
      vim.keymap.set("n", "<space>wr", vim.lsp.buf.remove_workspace_folder(), bufopts)
      vim.keymap.set("n", "K", vim.lsp.buf.hover(), bufopts)
      vim.keymap.set("n", "[d", vim.lsp.diagnostic.goto_prev(), bufopts)
      vim.keymap.set("n", "]d", vim.lsp.diagnostic.goto_next(), bufopts)
      vim.keymap.set("n", "gD", vim.lsp.buf.declaration(), bufopts)
      vim.keymap.set("n", "gd", vim.lsp.buf.definition(), bufopts)
      vim.keymap.set("n", "gi", vim.lsp.buf.implementation(), bufopts)
      vim.keymap.set("n", "gi", vim.lsp.buf.implementation, bufopts)
      vim.keymap.set("n", "gr", vim.lsp.buf.references(), bufopts)
      vim.keymap.set("n", "grf", vim.lsp.buf.references, bufopts)
      vim.keymap.set("n", "gtD", vim.lsp.buf.type_definition, bufopts)
    end
    lspconfig[server_name].setup(opts)
  end,
}
mason_lspconfig.setup {
  ensure_installed = servers,
  automatic_installation = true,
}
local mason_package = require "mason-core.package"
